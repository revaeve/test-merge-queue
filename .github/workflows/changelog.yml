name: Release

on:
  push:
    branches: ['main']

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          # ref: ${{ github.event.pull_request.head.ref }}
      - uses: nrwl/nx-set-shas@v3
      - run: npm ci

      # - name: Log affected directories
      #   run: echo ${{ steps.nx-changes.outputs.changed-dirs }}

      - name: Log latest commit message
        run: echo ${{ github.event.head_commit.message }}

      # - name: Update changelogs in affected directories
      #   run: |
      #     echo -e "\n---\n\nCommit Message: ${{ github.event.head_commit.message }}\n" >> ${{ steps.nx-changes.outputs.changed-dirs }}

      - name: Generate affected graph json
        run: npx nx affected:graph --file=affected.json

      - name: Update changelogs
        run: node scripts/update-changelogs.js
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}

      # - name: Show diff
      #   run: |
      #     git diff --exit-code

      - name: Commit and push changes if there are any
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git diff --exit-code || (git add . && git commit -m "Update CHANGELOG.md in affected directories" && git push)

      # - uses: stefanzweifel/git-auto-commit-action@v4
      #   with:
      #     commit_message: Update CHANGELOG.md in affected apps

      # script for modify changelog
